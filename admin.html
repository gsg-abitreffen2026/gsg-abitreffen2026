<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Abi 2006</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f2ef;
      color: #1c1e21;
    }

    header {
      background-color: #0073b1;
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    textarea {
      width: 100%;
      max-width: 500px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #0073b1;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background-color: #005f90;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    .checkbox {
      transform: scale(1.2);
      margin-right: 8px;
    }

    .section {
      margin-top: 2rem;
    }

    .newsletter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }

    .newsletter-controls input[type="text"] {
      flex: 1;
    }

    textarea {
      height: 120px;
    }

    @media (max-width: 600px) {
      .newsletter-controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Admin-Login</h1>
</header>

<div class="container">
  <!-- Login-Bereich -->
  <div id="loginSection">
    <div class="form-group">
      <label for="adminPassword">Passwort</label>
      <input type="password" id="adminPassword" placeholder="Admin-Passwort" />
    </div>
    <button onclick="login()">Einloggen</button>
    <p id="loginError" style="color: red; margin-top: 1rem;"></p>
  </div>

  <!-- Adminbereich -->
  <div id="adminSection" class="hidden">
    <h2>Adminbereich</h2>

    <!-- Anmeldungen -->
    <div class="section">
      <h3>Offene Anmeldungen</h3>
      <button onclick="freigabeMehrerer()">Mehrere freigeben</button>
      <table id="offeneTabelle">
        <thead>
          <tr>
            <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
            <th>Vorname</th>
            <th>Nachname</th>
            <th>E-Mail</th>
            <th>Löschen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Galerie -->
    <div class="section">
      <h3>Freigaben / Galerie-Zugänge</h3>
      <table id="freigabeTabelle">
        <thead>
          <tr>
            <th>Vorname</th>
            <th>Nachname</th>
            <th>E-Mail</th>
            <th>Zugangscode</th>
            <th>Löschen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Newsletter -->
    <div class="section">
      <h3>Newsletter schreiben</h3>
      <div class="form-group">
        <label for="newsletterText">Nachricht</label>
        <textarea id="newsletterText" placeholder="Text hier eingeben..."></textarea>
      </div>
      <div class="newsletter-controls">
        <input type="text" id="newsletterSubject" placeholder="Betreff..." />
        <input type="email" id="testEmail" placeholder="Test-E-Mail" />
        <button onclick="sendTest()">Test senden</button>
        <button onclick="sendNewsletter()">An alle senden</button>
      </div>
      <p id="newsletterStatus" style="margin-top: 1rem;"></p>
    </div>
  </div>
</div>

<script>
  const ADMIN_PASSWORD = "wallnuss26"; // ✨ hier anpassen

  function login() {
    const pw = document.getElementById("adminPassword").value;
    if (pw === ADMIN_PASSWORD) {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("adminSection").classList.remove("hidden");
      loadAdminData();
    } else {
      document.getElementById("loginError").textContent = "Falsches Passwort!";
    }
  }

  async function loadAdminData() {
    const res = await fetch("https://script.google.com/macros/s/AKfycbxtc0G6CDfMloMew6j1LySqSsEOqUvIzHnF4dsad7mn0NXOKwPO0q3QEBQMymKqKCwg/exec");
    const data = await res.json();

    const offene = data.anmeldungen.sort((a,b)=>a.vorname.localeCompare(b.vorname));
    const galerie = data.galerie.sort((a,b)=>a.vorname.localeCompare(b.vorname));

    const t1 = document.querySelector("#offeneTabelle tbody");
    const t2 = document.querySelector("#freigabeTabelle tbody");
    t1.innerHTML = "";
    t2.innerHTML = "";

    offene.forEach((row, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="freigabe-checkbox" data-index="${i}"></td>
        <td>${row.vorname}</td>
        <td>${row.nachname}</td>
        <td>${row.email}</td>
        <td><button onclick="loeschen('${row.email}')">Löschen</button></td>`;
      t1.appendChild(tr);
    });

    galerie.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.vorname}</td>
        <td>${row.nachname}</td>
        <td>${row.email}</td>
        <td>${row.code}</td>
        <td><button onclick="loeschen('${row.email}')">Löschen</button></td>`;
      t2.appendChild(tr);
    });
  }

  function toggleAll(master) {
    document.querySelectorAll(".freigabe-checkbox").forEach(cb => cb.checked = master.checked);
  }

  async function freigabeMehrerer() {
    const selected = Array.from(document.querySelectorAll(".freigabe-checkbox"))
      .filter(cb => cb.checked)
      .map(cb => cb.closest("tr").children[3].textContent); // E-Mail-Zelle

    if (selected.length === 0) return;

    const res = await fetch("https://script.google.com/macros/s/AKfycbxtc0G6CDfMloMew6j1LySqSsEOqUvIzHnF4dsad7mn0NXOKwPO0q3QEBQMymKqKCwg/exec", {
      method: "POST",
      body: new URLSearchParams({
        action: "freigeben",
        passwort: "wallnuss26",
        emails: JSON.stringify(selected)
      })
    });

    const result = await res.text();
    alert(result);
    loadAdminData();
  }

  async function loeschen(email) {
    if (!confirm("Willst du den Nutzer wirklich löschen?")) return;
    const res = await fetch("https://script.google.com/macros/s/AKfycbxtc0G6CDfMloMew6j1LySqSsEOqUvIzHnF4dsad7mn0NXOKwPO0q3QEBQMymKqKCwg/exec", {
      method: "POST",
      body: new URLSearchParams({
        action: "loeschen",
        passwort: "wallnuss26",
        email: email
      })
    });

    const result = await res.text();
    alert(result);
    loadAdminData();
  }

  async function sendTest() {
    const text = document.getElementById("newsletterText").value;
    const subject = document.getElementById("newsletterSubject").value;
    const test = document.getElementById("testEmail").value;

    const res = await fetch("https://script.google.com/macros/s/AKfycbxtc0G6CDfMloMew6j1LySqSsEOqUvIzHnF4dsad7mn0NXOKwPO0q3QEBQMymKqKCwg/exec", {
      method: "POST",
      body: new URLSearchParams({
        action: "testmail",
        passwort: "wallnuss26",
        text: text,
        subject: subject,
        email: test
      })
    });

    const result = await res.text();
    document.getElementById("newsletterStatus").textContent = result;
  }

  async function sendNewsletter() {
    const text = document.getElementById("newsletterText").value;
    const subject = document.getElementById("newsletterSubject").value;

    const res = await fetch("https://script.google.com/macros/s/AKfycbxtc0G6CDfMloMew6j1LySqSsEOqUvIzHnF4dsad7mn0NXOKwPO0q3QEBQMymKqKCwg/exec", {
      method: "POST",
      body: new URLSearchParams({
        action: "newsletter",
        passwort: "wallnuss26",
        text: text,
        subject: subject
      })
    });

    const result = await res.text();
    document.getElementById("newsletterStatus").textContent = result;
  }
</script>

</body>
</html>
